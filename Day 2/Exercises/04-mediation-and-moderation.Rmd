---
title: "Scales, mediation and moderation"
---

```{r setup}
#pacman::p_load(tidyverse, broom, lavaan, processR, sjPlot, interactions)
library(tidyverse)
library(lavaan)

ess_work <- read_rds("data/ess_work.RDS")
contact <- read_csv("https://raw.githubusercontent.com/LukasWallrich/PhD_thesis/master/Chapter%203%20-%20mediation%20UK/analysis/AllResponses.csv")
contact$InteractBlack[contact$InteractBlack > 0.30] <- 0.30 #Windsorizing outliers
```


## Your Turn 1

* Import the contact data (run the read_csv line above that gets it directly from my PhD repository).
* Run two `lm()` models to test the preconditions for testing whether the association between BSSlurACT and InteractBlack is mediated by AffBLACK
* Namely: is Y predicted by X and is Y predicted by M

```{r}


```

## Your Turn 2

* Type the lavaan model into the blank (___)
* Run the whole block and interpret the output (NB: this will take ~20 seconds)


```{r}
model_code <- ("
___
               ")

sem(model_code, contact, se = "bootstrap", bootstrap = 1000) %>% 
  summary(ci = TRUE)

```


## Your Turn 3

* Test whether household income (`hinctnta`) moderates the relationship between health and happiness (in the ess_work data)
- Run the `lm()` model testing whether health interacts with income in predicting happiness
- Put the result into the `plot_model()` function with `type = "int"` - if it does not show what you want, try to switch the order of the predictors in `lm()`

NB: `plot_model()` sometimes struggles with labelled data - therefore, it's worth using zap_labels() here.

```{r}

mod_mod <- ess_UK %>% haven::zap_labels() %>% lm(____, data = .)

```


## Reporting simple slopes and Johnson-Neyman intervals

You can use the code below to get all details needed to report simple slopes. `?interactions::sim_slopes` reveals many customisation options.

```{r}
interactions::sim_slopes(mod_mod, pred = "health", modx = "hinctnta")
```

## Your turn 4

* Fill in the blanks and try to understand what's going on
* Run the code and compare the output to the simple slopes above

```{r}
model_code <- ("
#Regression model
happy ~ a * health + b * hinctnta + c * health:hinctnta

#Ingredients for simple slopes
hinctnta ~ ____ * 1
hinctnta ~~ _____ * hinctnta

#Simple slopes
SDbelow := a + c * (M_hinctnta - ____(var_hinctnta))
Mean := a + c * M_hinctnta
SDabove:= _____
")

sem(model = _____, data = ____) %>% 
  summary()

```

## Your turn 5

We established that in `contact` the association between `BSSlurACT` and `InteractBlack` is mediated by `AffBLACK`. Is that moderated by prejudicial beliefs (`WhAnxHALL`)?

* Extract code for a Model 8 from the [processR web app](https://cardiomoon.shinyapps.io/processR/) (for that, you need to assign variables - unless you want to upload the dataset there, just take note and then search/replace the variables with the names you want to use)
* Adjust that code to reflect the model you are interested in and save it into a `model_code` object
* Set the random seed to 12345 so that we all get the same results.
* Run `sem()` with 1000 bootstraps and look at the `summary()` of results.

```{r}


```


***

# Take Aways

* Mediation and moderation models can be coded in `lavaan` - highly flexible, and learning then also transfers to  SEM and other path modeling
* Coding is not trivial - but no need to start from scratch. Many code examples can be found - most comprehensively in the processR package/webapp
* Simpler tools are available - `JSmediation` package looks promising