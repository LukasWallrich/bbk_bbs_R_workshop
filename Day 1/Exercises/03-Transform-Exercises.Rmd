---
title: "Transform Data"
---

```{r setup}
library(tidyverse)

# Toy dataset that we will use later on - ignore for now

pollution <- tribble(
       ~city,   ~size, ~amount, 
  "New York", "large",      23,
  "New York", "small",      14,
    "London", "large",      22,
    "London", "small",      16,
   "Beijing", "large",      121,
   "Beijing", "small",      56
)

```

# Import Data

## Your Turn 1

Import the `babynames.csv` data set, which is in the `data` folder, as `babynames`. Then put the import code into the code chunk below. Make sure that you can run it from there - you might need to adjust the path.

```{r}
babynames <- _____
```

# dplyr

## Your Turn 2

Use `filter`, `babynames`, and the logical operators to find:

* All of the names where prop is greater than or equal to 0.08  
* All of the children named "Sea"  

```{r}

```

## Your Turn 3

Use Boolean operators to return only the rows that contain:

* _Boys_ named Sue  
* Names that were used by exactly 5 or 6 children in 1880  
* Names that are one of Acura, Lexus, or Yugo

```{r}

```

## Your Turn 4

Use arrange to find 

* the name that was most common in a single year (i.e. highest n)
* the name that had the highest proportion in a single year (i.e. highest prop)

```{r}

```


## Your Turn 5

Alter the code to select just the `n` column:

```{r}
select(babynames, name, prop)
```

## Abbreviations and helper functions 

```{r}
ess_mini <- read_rds("data/ess_mini.RDS")
names(ess_mini) #See the column names

select(ess_mini, height:happy)
select(ess_mini, -c(main_activity, working_hours))

select(ess_mini, starts_with("work"))
select(ess_mini, ends_with("t"))

select(ess_mini, matches("ei")) #Contains "ei"
select(ess_mini, matches("^.{6}$")) #6 characters long

select(billboard, artist, track, num_range("wk", 10:15))

```


## Quiz

Which of these is NOT a way to select the `name` and `n` columns together?

```{r}
ess_mini_UK <- read_rds("data/ess_mini_UK.RDS")
select(babynames, -c(year, sex, prop))
select(babynames, name:n)
select(babynames, starts_with("n"))
select(babynames, ends_with("n"))
```

## Your Turn 6

Use `%>%` to write a sequence of functions that: 

1. Filters babynames to just the girls that were born in 2017, *then...*  
2. Selects the `name` and `n` columns, *then...*  
3. Arranges the results so that the most popular names are near the top.

```{r}

```

## Your Turn 7 - Exam

1. Trim `babynames` to just the rows that contain your `name` and your `sex`  - or simply your favourite US name
2. Trim the result to just the columns that will appear in your graph (not necessary here, but worth practicing)  
3. Plot the results as a line graph with `year` on the x axis and `prop` on the y axis

```{r}

```

## Your Turn 8

Copmplete the code below to extract the rows where `name == "Khaleesi"`. Then use `summarise()` and `sum()` and `min()` to find:

1. The total number of children named Khaleesi
2. The first year Khaleesi appeared in the data

*(Hint: Be sure to remove each `_` before running the code)*

```{r}
babynames ___ 
  filter(_______________________) ___
  ___________(total = ________, first = _______)
```

## Your Turn 9

Use `group_by()`, `summarise()`, and `arrange()` to display the ten most popular names. Compute popularity as the *total* number of children of a single gender given a name.

*(Hint: Be sure to remove each `_` before running the code)*

```{r}
babynames %>%
  _______(name, sex) %>% 
  _______(total = _____(n)) %>% 
  _______(desc(_____))
```

## Your Turn 10

Use `group_by()` to calculate and then plot the total number of children born each year over time.

```{r}

```

## Your Turn 11

Use `mutate()` and `min_rank()`to rank each row in babynames from _largest_ n to lowest n.

*(Hint: Be sure to remove each `_` before running the code)*

```{r}
babynames %>% 
  ______(rank = _______(____(n)))
```

## Your Turn 12

Group `babynames` by **year** and re-rank the data. Then calculate the median rank for each name-sex combination across years, and arrange by that median rank.

```{r}

```

***

# Take aways

* Extract cases with `filter()`  
* Arrange cases, with `arrange()`  
* Extract variables with `select()`  

* Make tables of summaries with `summarise()`  
* Make new variables, with `mutate()`  
* Do groupwise operations with `group_by()`

* Connect operations with `%>%`  


# Sample graphs

```{r}
babynames %>% 
  filter(name %in% c("Alexandra", "Evan", "Kevin")) %>%  
  ggplot(aes(year, prop, color = name, linetype = sex)) + 
  geom_line() + 
  scale_y_continuous(labels = scales::label_percent())
```

```{r}
babynames %>% 
    group_by(year, sex) %>% 
    mutate(rank = min_rank(desc(prop))) %>% 
    group_by(name, sex) %>% 
    summarise(median_rank = median(rank)) %>% 
    group_by(sex) %>% 
    arrange(median_rank) %>% 
    slice(1:10) %>% 
    ggplot() +
    geom_col(mapping = aes(x = fct_reorder(name, median_rank), y = median_rank)) +
    facet_wrap(vars(sex), scales = "free_x") +
    theme_bw() +
    labs(x = "name", y = "Median Rank")

```


